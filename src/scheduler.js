import cron from 'node-cron'; import { listWatchesAdmin } from './db.js'; import { runScan } from './service.js'; export function startScheduler(){ if(String(process.env.SCHEDULER_ENABLED||'true')!=='true'){ console.log('[Scheduler] disabled'); return; } const expr=process.env.CRON_SCHEDULE||'*/20 * * * *'; console.log('[Scheduler] cron:',expr); cron.schedule(expr, async ()=>{ try{ const items=listWatchesAdmin().filter(w=>w.active); for (const w of items){ await runScan(w);} }catch(e){ console.error('[Scheduler]',e);} }, { timezone:'Europe/London' }); }