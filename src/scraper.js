import got from 'got'; import * as cheerio from 'cheerio'; const BASE='https://www.nhs.uk'; export function searchUrl(postcode,radiusMiles){ const km=Math.max(1,Math.round(radiusMiles*1.60934)); return `${BASE}/service-search/find-a-dentist/results/${encodeURIComponent(postcode)}?distance=${km}`;} export async function fetchHtml(url){ const res=await got(url,{ headers:{'user-agent':'DentistRadarBot/1.1 (+https://dentistradar.co.uk)'}, http2:true, timeout:{request:15000}}); return res.body;} export function parseList(html){ const $=cheerio.load(html); const out=[]; $('a.nhsuk-card__link, h2 a, h3 a').each((i,el)=>{ let name=$(el).text().trim(); let href=$(el).attr('href')||''; if(href && !href.startsWith('http')) href=BASE+href; if(name&&href) out.push({name,url:href}); }); const uniq=new Map(); out.forEach(x=>uniq.set(x.url,x)); return Array.from(uniq.values()); } export function parseStatus(html){ const $=cheerio.load(html); const bits=[]; $('p, li, dd').each((i,el)=>{ const t=$(el).text().trim(); if(/accepting/i.test(t)) bits.push(t); }); const statusText=bits[0]||''; const accepting=/accepting\s+new\s+nhs\s+patients/i.test(statusText)||(/accepting/i.test(statusText)&&/nhs/i.test(statusText)); return { statusText, acceptingFlag: accepting?1:0 }; }