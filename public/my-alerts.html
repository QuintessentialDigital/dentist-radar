<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Alerts – DentistRadar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color-scheme: light;
    }
    body {
      margin: 0;
      background:#f3f4f6;
    }
    header {
      background:#0b63ff;
      color:#ffffff;
      padding:14px 18px;
    }
    header .inner {
      max-width:900px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    header h1 {
      margin:0;
      font-size:18px;
    }
    header a {
      color:#e5e7eb;
      text-decoration:none;
      font-size:13px;
    }
    main {
      max-width:900px;
      margin:18px auto 32px;
      padding:0 16px;
    }
    h2 {
      margin:0 0 8px;
      font-size:18px;
    }
    .muted {
      color:#6b7280;
      font-size:13px;
    }

    .card {
      background:#ffffff;
      border-radius:12px;
      padding:16px 18px;
      border:1px solid #e5e7eb;
      box-shadow:0 8px 20px rgba(15,23,42,0.05);
      margin-top:16px;
    }

    label {
      font-size:13px;
      display:block;
      margin-bottom:4px;
    }
    input[type="email"] {
      width:100%;
      max-width:320px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
    }
    button {
      padding:8px 14px;
      border-radius:999px;
      border:none;
      background:#0b63ff;
      color:#ffffff;
      font-size:14px;
      cursor:pointer;
      font-weight:500;
      margin-left:8px;
    }
    button:hover { background:#084ccf; }
    button:disabled {
      opacity:0.65;
      cursor:default;
    }

    .status {
      margin-top:8px;
      font-size:13px;
    }
    .status.ok { color:#15803d; }
    .status.err { color:#b91c1c; }
    .status.info { color:#6b7280; }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td {
      padding:8px 6px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    th {
      font-size:12px;
      color:#6b7280;
    }
    .pill {
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#374151;
    }
    .pill.inactive {
      border-color:#fecaca;
      background:#fef2f2;
      color:#b91c1c;
    }
    .pill.active {
      border-color:#bbf7d0;
      background:#ecfdf3;
      color:#166534;
    }
    .actions button {
      margin-left:0;
      margin-right:4px;
      padding:6px 10px;
      font-size:12px;
      box-shadow:none;
    }
    .actions button.delete {
      background:#ef4444;
    }
    .actions button.delete:hover {
      background:#b91c1c;
    }

    .empty-state {
      margin-top:10px;
      font-size:13px;
      color:#6b7280;
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>My Alerts</h1>
      <a href="/">← Back to DentistRadar</a>
    </div>
  </header>

  <main>
    <section>
      <h2>Manage your alerts</h2>
      <p class="muted">
        Enter the email address you used when creating your alerts.
        We’ll show all active and previously unsubscribed alerts linked to it.
      </p>
      <div class="card">
        <form id="lookupForm">
          <label for="email">Email address</label>
          <input id="email" name="email" type="email" required autocomplete="email" placeholder="you@example.com" />
          <button type="submit" id="lookupBtn">Show my alerts</button>
        </form>
        <div id="lookupStatus" class="status"></div>
      </div>
    </section>

    <section id="alertsSection" style="display:none;">
      <div class="card" id="alertsCard">
        <h2 style="margin-top:0;">Your alerts</h2>
        <p class="muted" id="alertsIntro"></p>
        <div id="alertsContainer"></div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const form = $("lookupForm");
      const emailInput = $("email");
      const lookupBtn = $("lookupBtn");
      const statusEl = $("lookupStatus");
      const alertsSection = $("alertsSection");
      const alertsIntro = $("alertsIntro");
      const alertsContainer = $("alertsContainer");

      function setStatus(msg, type) {
        statusEl.textContent = msg || "";
        statusEl.className = "status " + (type || "info");
      }

      function escapeHtml(s) {
        return (s || "").toString().replace(/[&<>"']/g, (c) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
        );
      }

      function renderAlerts(email, watches) {
        alertsSection.style.display = "block";
        alertsIntro.textContent =
          watches.length === 0
            ? "No alerts found for " + email + "."
            : "Alerts linked to " + email + ":";

        if (!watches.length) {
          alertsContainer.innerHTML =
            '<p class="empty-state">If you have just created an alert, please check your inbox for the confirmation email.</p>';
          return;
        }

        let rows = "";
        watches.forEach((w) => {
          const pc = escapeHtml(w.postcode || "");
          const radius = w.radius || 0;
          const active = w.active !== false;
          const created = w.createdAt
            ? new Date(w.createdAt).toLocaleString("en-GB", { hour12: false })
            : "";
          const unsub = w.unsubscribedAt
            ? new Date(w.unsubscribedAt).toLocaleString("en-GB", { hour12: false })
            : "";

          rows += `
            <tr data-id="${w._id}">
              <td>${pc}</td>
              <td>${radius}</td>
              <td>
                ${
                  active
                    ? '<span class="pill active">Active</span>'
                    : '<span class="pill inactive">Unsubscribed</span>'
                }
              </td>
              <td>
                ${created ? escapeHtml(created) : ""}
                ${unsub ? `<br><span class="muted">Unsubscribed: ${escapeHtml(unsub)}</span>` : ""}
              </td>
              <td class="actions">
                ${
                  active
                    ? `<button type="button" class="delete" data-action="unsubscribe">Unsubscribe</button>`
                    : ""
                }
              </td>
            </tr>
          `;
        });

        alertsContainer.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Postcode</th>
                <th>Radius (miles)</th>
                <th>Status</th>
                <th>Created / Unsubscribed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;

        // Attach click handlers for Unsubscribe buttons
        alertsContainer.querySelectorAll("button[data-action='unsubscribe']")
          .forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const row = e.target.closest("tr");
              const id = row && row.getAttribute("data-id");
              if (!id) return;

              if (!confirm("Unsubscribe this alert?")) return;

              try {
                const res = await fetch(
                  `/api/watch/${encodeURIComponent(id)}?email=${encodeURIComponent(email)}`,
                  { method: "DELETE" }
                );
                const data = await res.json();
                if (!data.ok) {
                  alert("Unable to unsubscribe this alert. Please try again.");
                  return;
                }
                // Mark as unsubscribed in UI
                row.querySelector("td:nth-child(3)").innerHTML =
                  '<span class="pill inactive">Unsubscribed</span>';
                const tsCell = row.querySelector("td:nth-child(4)");
                const now = new Date().toLocaleString("en-GB", { hour12: false });
                tsCell.innerHTML += `<br><span class="muted">Unsubscribed: ${escapeHtml(now)}</span>`;
                const actionsCell = row.querySelector("td:nth-child(5)");
                actionsCell.innerHTML = "";
              } catch (err) {
                console.error(err);
                alert("Server error, please try again.");
              }
            });
          });
      }

      async function loadAlerts(email) {
        setStatus("Loading alerts…", "info");
        alertsSection.style.display = "none";
        alertsContainer.innerHTML = "";

        try {
          const res = await fetch(
            `/api/watch/list?email=${encodeURIComponent(email)}`
          );
          const data = await res.json();
          if (!data.ok) {
            setStatus("Could not load alerts. Please check your email address.", "err");
            return;
          }
          setStatus("Alerts loaded.", "ok");
          renderAlerts(email, data.watches || []);
        } catch (err) {
          console.error(err);
          setStatus("Server error. Please try again.", "err");
        }
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();
        if (!email) {
          setStatus("Please enter your email address.", "err");
          return;
        }
        lookupBtn.disabled = true;
        loadAlerts(email).finally(() => {
          lookupBtn.disabled = false;
        });
      });

      // If email comes from URL (?email=...)
      const params = new URLSearchParams(window.location.search);
      const preEmail = params.get("email");
      if (preEmail) {
        emailInput.value = preEmail;
        loadAlerts(preEmail);
      }
    })();
  </script>
</body>
</html>
