<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DentistRadar – My Alerts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 24px 12px;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.08);
      border: 1px solid #e5e7eb;
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #111827;
    }
    p {
      font-size: 0.95rem;
      color: #4b5563;
    }
    .banner {
      background:#fff7d6;
      border:1px solid #f0e1a0;
      border-radius:10px;
      padding:8px 12px;
      font-size:13px;
      color:#7a5a00;
      margin-bottom:16px;
    }
    label {
      display:block;
      margin-top:8px;
      font-size:0.9rem;
      font-weight:600;
    }
    input[type="email"] {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:0.95rem;
      margin-top:4px;
    }
    button {
      border-radius:999px;
      border:none;
      padding:8px 16px;
      font-size:0.9rem;
      cursor:pointer;
    }
    .btn-primary {
      background:#0b63ff;
      color:#fff;
      margin-top:10px;
    }
    .btn-danger {
      background:#dc2626;
      color:#fff;
    }
    .alerts {
      margin-top:18px;
      border-top:1px solid #e5e7eb;
      padding-top:16px;
    }
    .alert-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
      font-size:0.9rem;
    }
    .alert-meta {
      color:#374151;
    }
    .muted {
      color:#9ca3af;
      font-size:0.85rem;
    }
    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
      background:#e5f0ff;
      color:#0b63ff;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="banner">
      <strong>Important:</strong>
      DentistRadar currently supports NHS dentist searches in
      <strong>England</strong> only. Support for Scotland, Wales and Northern Ireland is planned.
    </div>

    <h1>Manage your alerts</h1>
    <p>
      Enter the email address you used when creating your alerts. You can review and delete any active alerts.
    </p>

    <label for="emailInput">Email address</label>
    <input id="emailInput" type="email" placeholder="you@example.com" />
    <button class="btn-primary" id="loadBtn">Load my alerts</button>

    <div class="alerts" id="alertsSection" style="display:none;">
      <h2 style="font-size:1.1rem; margin:0 0 8px 0;">Your alerts</h2>
      <div id="alertsList"></div>
    </div>

    <p class="muted" style="margin-top:18px;">
      Tip: If you no longer need DentistRadar, you can also unsubscribe directly from any alert email we send you.
    </p>
  </div>

  <script>
    const emailInput = document.getElementById("emailInput");
    const loadBtn = document.getElementById("loadBtn");
    const alertsSection = document.getElementById("alertsSection");
    const alertsList = document.getElementById("alertsList");

    function getEmailFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("email") || "";
    }

    async function loadAlerts() {
      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        alert("Please enter your email address.");
        return;
      }

      alertsList.innerHTML = '<p class="muted">Loading alerts…</p>';
      alertsSection.style.display = "block";

      try {
        const res = await fetch(`/api/watch/list?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        if (!data.ok) {
          alertsList.innerHTML = '<p class="muted">Could not load alerts. Please check your email.</p>';
          return;
        }

        const watches = data.watches || [];
        if (watches.length === 0) {
          alertsList.innerHTML = '<p class="muted">You do not have any active alerts yet.</p>';
          return;
        }

        alertsList.innerHTML = "";
        watches.forEach((w) => {
          const div = document.createElement("div");
          div.className = "alert-item";
          div.innerHTML = `
            <div class="alert-meta">
              <strong>${w.postcode || ""}</strong>
              <span class="badge">${w.radius || w.radiusMiles || 5} miles</span><br/>
              <span class="muted">Created: ${
                w.createdAt ? new Date(w.createdAt).toLocaleDateString() : "N/A"
              }</span>
            </div>
            <div>
              <button class="btn-danger" data-id="${w._id}">Delete</button>
            </div>
          `;
          alertsList.appendChild(div);
        });

        alertsList.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Delete this alert?")) return;

            const res = await fetch(
              `/api/watch/${encodeURIComponent(id)}?email=${encodeURIComponent(email)}`,
              { method: "DELETE" }
            );
            const data = await res.json();
            if (!data.ok) {
              alert("Could not delete this alert. Please try again.");
            } else {
              btn.closest(".alert-item").remove();
              if (!alertsList.children.length) {
                alertsList.innerHTML = '<p class="muted">You do not have any active alerts.</p>';
              }
            }
          });
        });
      } catch (err) {
        console.error(err);
        alertsList.innerHTML = '<p class="muted">Something went wrong loading your alerts.</p>';
      }
    }

    loadBtn.addEventListener("click", loadAlerts);

    // If email is present in query string, pre-fill and auto-load
    const queryEmail = getEmailFromQuery();
    if (queryEmail) {
      emailInput.value = queryEmail;
      loadAlerts();
    }
  </script>
</body>
</html>
