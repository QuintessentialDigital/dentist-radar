<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin — Dentist Radar</title>
<link rel="icon" href="/assets/logo.svg"/>
<link rel="stylesheet" href="/assets/theme.css"/>
</head><body>
<nav class="navbar"><div class="nav-inner"><a class="brand" href="/"><img src="/assets/logo.svg" alt=""/> Dentist Radar</a><div class="nav-links"><a href="/pricing.html">Pricing</a></div></div></nav>

<div class="wrap">
  <div class="card"><h1>Admin</h1><p class="lead" id="msg">Create test watch, list watches, send test email, simulate availability.</p></div>
  <div class="card">
    <div class="grid">
      <div class="full"><label>Email</label><div class="input"><input id="email" placeholder="you@gmail.com"/></div></div>
      <div class="full"><label>Postcodes (comma separated)</label><div class="input"><input id="postcode" placeholder="RG41, RG1, SL6"/></div></div>
      <div class="col-4"><label>Radius</label><div class="input"><input id="radius" type="number" value="10" min="1" max="30"/></div></div>
      <div class="full"><div class="mt-12"><button class="btn" id="createBtn">Create test watch</button> <button class="btn outline" id="refreshBtn">Refresh list</button></div></div>
      <div class="full"><div class="mt-12"><div class="input"><input id="testTo" placeholder="test-email@yourdomain.com" style="max-width:320px"/></div> <button class="btn" id="sendTestBtn">Send test email</button></div></div>
      <div class="full"><div class="mt-12"><div class="input"><input id="availPractice" placeholder="Practice name" style="max-width:280px"/></div><div class="input"><input id="availPostcode" placeholder="Postcode prefix e.g. RG41" style="max-width:180px"/></div><div class="input"><input id="availLink" placeholder="Optional link to NHS page" style="max-width:360px"/></div> <button class="btn" id="simulateBtn">Simulate availability</button></div></div>
    </div>
  </div>

  <div class="card"><h2>Watches</h2><div id="list"></div></div>
  <div class="card"><a href="/">← Back to Home</a></div>
</div>

<script>
function setMsg(t, ok=true){ const el=document.getElementById('msg'); el.style.color = ok ? '#22C55E' : '#F87171'; el.textContent=t; }

async function createTest(){
  const email = document.getElementById('email').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const radius = Number(document.getElementById('radius').value || 10);
  if (!email || !postcode){ setMsg('Please enter both email and postcode(s).', false); return; }
  try{
    const res = await fetch('/api/watch', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email, postcode, radius_miles: radius }) });
    const txt = await res.text(); let j; try{ j = JSON.parse(txt);}catch(e){ j=null; }
    if (!res.ok){ setMsg('HTTP '+res.status+': '+(j?.error || txt || 'failed'), false); return; }
    if (j && j.ok){ setMsg('Created ' + (j.created?.length||1) + ' area(s).', true); load(); }
    else { setMsg('Error: ' + (j?.error || 'failed'), false); }
  }catch(e){ setMsg('Network error: ' + e.message, false); }
}

async function load(){
  try{
    const pass = prompt('Admin password (set ADMIN_PASSWORD env):','');
    if (pass===null){ setMsg('Load canceled.', false); return; }
    const res = await fetch('/api/admin/watches', { headers: { Authorization: 'Basic ' + btoa('admin:'+pass) } });
    if (!res.ok){ setMsg('Auth failed or server error ('+res.status+'). Check ADMIN_PASSWORD.', false); return; }
    const j = await res.json();
    const root = document.getElementById('list'); root.innerHTML='';
    if (!j.items || j.items.length===0){ root.innerHTML='<div class="lead">No watches yet.</div>'; return; }
    j.items.forEach(w=>{
      const d = document.createElement('div'); d.className='card';
      d.innerHTML = `<strong>#${w.id}</strong> · ${w.postcode} · ${w.radius_miles} miles · email: ${w.email}
      <div class="mt-12"><button class="btn" data-id="${w.id}">Run now</button></div>`;
      d.querySelector('button').onclick = ()=> runScan(w.id, d.querySelector('button'));
      root.appendChild(d);
    });
    setMsg('Loaded '+j.items.length+' watch(es).', true);
  }catch(e){ setMsg('Could not load watches: ' + e.message, false); }
}

async function runScan(id, btn){
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Running…';
  try{
    const res = await fetch('/api/watch/'+id+'/run', { method:'POST' });
    const j = await res.json();
    if (j.ok){ setMsg('Scan complete. Alerts sent: ' + (j.result?.alerts || 0), true); }
    else { setMsg('Scan failed: ' + (j.error || 'failed'), false); }
  }catch(e){ setMsg('Scan error: ' + e.message, false); }
  btn.disabled = false; btn.textContent = old;
}

async function sendTestEmail(){
  try{
    const to = document.getElementById('testTo').value.trim();
    if(!to){ setMsg('Please enter a test email address.', false); return; }
    const pass = prompt('Admin password (set ADMIN_PASSWORD env):','');
    if (pass===null){ return; }
    const res = await fetch('/api/admin/test-email', {
      method:'POST',
      headers:{ 'content-type':'application/json', Authorization: 'Basic ' + btoa('admin:'+pass) },
      body: JSON.stringify({ to })
    });
    if(!res.ok){ setMsg('Could not send test email ('+res.status+').', false); return; }
    setMsg('Test email sent to ' + to, true);
  }catch(e){ setMsg('Test email error: ' + e.message, false); }
}

async function simulateAvailability(){
  try{
    const practice = document.getElementById('availPractice').value.trim();
    const postcode = document.getElementById('availPostcode').value.trim();
    const link = document.getElementById('availLink').value.trim();
    if (!practice || !postcode){ setMsg('Please enter practice and postcode prefix.', false); return; }
    const pass = prompt('Admin password (set ADMIN_PASSWORD env):','');
    if (pass===null){ return; }
    const res = await fetch('/api/admin/availability', {
      method:'POST',
      headers:{ 'content-type':'application/json', Authorization: 'Basic ' + btoa('admin:'+pass) },
      body: JSON.stringify({ practice, postcode, link })
    });
    const j = await res.json();
    if(!res.ok || !j.ok){ setMsg('Failed: ' + (j.error || res.status), false); return; }
    setMsg('Simulated availability: matched '+j.matched+' watches, sent '+j.sent+' emails.', true);
  }catch(e){ setMsg('Simulate error: ' + e.message, false); }
}

document.getElementById('createBtn').addEventListener('click', createTest);
document.getElementById('refreshBtn').addEventListener('click', load);
document.getElementById('sendTestBtn').addEventListener('click', sendTestEmail);
document.getElementById('simulateBtn').addEventListener('click', simulateAvailability);
</script>
</body></html>