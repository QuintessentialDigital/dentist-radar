<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî Dentist Radar</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;max-width:900px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{background:#0a7;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .card{border:1px solid #eee;border-radius:12px;padding:12px;margin:8px 0}
  #msg{margin:6px 0;color:#333}
  input{padding:8px;border:1px solid #ddd;border-radius:8px}
  label{font-size:12px;color:#555}
</style>
</head>
<body>
  <h1>üõ† Admin</h1>
  <div id="msg">Tip: create a test watch with your email + postcode.</div>

  <!-- Quick create form -->
  <div class="card">
    <div class="row">
      <div>
        <label>Email</label><br/>
        <input id="email" placeholder="you@gmail.com" />
      </div>
      <div>
        <label>Postcode</label><br/>
        <input id="postcode" placeholder="RG41" />
      </div>
      <div>
        <label>Radius (miles)</label><br/>
        <input id="radius" type="number" value="10" min="1" max="50" />
      </div>
      <div style="align-self:end">
        <button class="btn" id="createBtn">Create test watch</button>
      </div>
      <div style="align-self:end">
        <button class="btn" id="refreshBtn" style="background:#066">Refresh list</button>
      </div>
    </div>
  </div>

  <h3>Watches</h3>
  <div id="list"></div>

<script>
function setMsg(t, ok=true){
  const el = document.getElementById('msg');
  el.style.color = ok ? '#0a7' : '#b00020';
  el.textContent = t;
}

async function createTest(){
  const email = document.getElementById('email').value.trim();
  const postcode = document.getElementById('postcode').value.trim().toUpperCase().replace(/\s+/g,'');
  const radius = Number(document.getElementById('radius').value || 10);

  if (!email || !postcode){
    setMsg('Please enter both email and postcode.', false);
    return;
  }

  try{
    const res = await fetch('/api/watch', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        email,
        postcode,
        radius_miles: radius,
        frequency_minutes: 60
      })
    });
    const j = await res.json();
    if (j.ok){
      setMsg('‚úÖ Watch created (ID #' + j.watch.id + ').');
      load();
    } else {
      setMsg('‚ùå Error creating watch: ' + (j.error || 'failed'), false);
    }
  }catch(e){
    setMsg('‚ùå Network error creating watch: ' + e.message, false);
  }
}

async function load(){
  try{
    const res = await fetch('/api/watches', { cache:'no-store' });
    const j = await res.json();
    const root = document.getElementById('list');
    root.innerHTML = '';
    if (!j.items || j.items.length === 0){
      root.innerHTML = '<div class="card">No watches yet. Create one above.</div>';
      return;
    }
    j.items.forEach(w=>{
      const d = document.createElement('div');
      d.className = 'card';
      d.innerHTML = `
        <strong>#${w.id}</strong> ¬∑ ${w.postcode} ¬∑ ${w.radius_miles} miles ¬∑ every ${w.frequency_minutes} min ¬∑ email: ${w.contact_email||'-'}
        <div style="margin-top:8px">
          <button class="btn" data-id="${w.id}">Run now</button>
        </div>
      `;
      d.querySelector('button').onclick = ()=> runScan(w.id, d.querySelector('button'));
      root.appendChild(d);
    });
  }catch(e){
    setMsg('‚ùå Could not load watches: ' + e.message, false);
  }
}

async function runScan(id, btn){
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Running...';
  try{
    const res = await fetch('/api/watch/' + id + '/run', { method:'POST' });
    const j = await res.json();
    if (j.ok){
      setMsg('‚úÖ Scan complete. Alerts sent: ' + (j.result?.alerts || 0));
    } else {
      setMsg('‚ùå Scan failed: ' + (j.error || 'failed'), false);
    }
  }catch(e){
    setMsg('‚ùå Scan error: ' + e.message, false);
  }
  btn.disabled = false; btn.textContent = old;
}

document.getElementById('createBtn').addEventListener('click', createTest);
document.getElementById('refreshBtn').addEventListener('click', load);
document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
