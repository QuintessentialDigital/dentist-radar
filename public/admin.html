<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DentistRadar – Admin Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
      max-width: 1100px;
    }
    h1 { margin-bottom: 4px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; flex-wrap:wrap; gap:14px; margin-bottom:14px; }
    label { display:flex; flex-direction:column; font-size:13px; }
    input[type="text"], input[type="number"] {
      padding:8px; min-width:220px; font-size:14px;
    }
    button {
      padding:10px 16px;
      background:#005eb8;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
    }
    button:hover { background:#014f96; }
    .ok { color:#0a7f2e; font-weight:600; }
    .err { color:#b00020; font-weight:600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-top:16px; }
    @media(max-width:900px){ .grid { grid-template-columns:1fr; } }
    .card {
      border:1px solid #ddd;
      border-radius:8px;
      padding:10px 12px;
      background:#fafafa;
      margin-bottom:10px;
    }
    .card h3 { margin:0 0 4px; font-size:14px; }
    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:#e5f0ff;
      color:#1f3a7a;
      margin-left:4px;
    }
    .section-title {
      margin:12px 0 4px;
      font-size:15px;
    }
    a {
      color:#005eb8;
      text-decoration:none;
    }
    a:hover { text-decoration:underline; }
  </style>
</head>

<body>
  <h1>DentistRadar – Admin Scanner</h1>
  <p class="muted">
    Manual NHS search tester. Uses <code class="mono">GET /api/scan?postcode=&radius=</code>
    and shows accepting / not-accepting / unknown practices for quick debugging.
  </p>

  <div class="row">
    <label>Postcode
      <input id="postcode" type="text" placeholder="e.g. RG41 4UW" />
    </label>

    <label>Radius (miles)
      <input id="radius" type="number" min="1" max="30" value="10" />
    </label>
  </div>

  <div class="row">
    <button id="run">Run Scan</button>
    <span id="status" class="muted"></span>
  </div>

  <div id="out"></div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const pcEl = $("postcode");
      const radiusEl = $("radius");
      const runBtn = $("run");
      const statusEl = $("status");
      const outEl = $("out");

      // Restore last used postcode / radius
      pcEl.value = localStorage.getItem("dr_admin_pc") || "";
      const savedRadius = localStorage.getItem("dr_admin_radius");
      if (savedRadius) radiusEl.value = savedRadius;

      function setStatus(msg, cls = "muted") {
        statusEl.className = cls;
        statusEl.textContent = msg;
      }

      function escapeHtml(s) {
        return (s || "").replace(/[&<>"']/g, (c) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
        );
      }

      function renderPracticeCard(p) {
        const name = escapeHtml(p.name || "Practice");
        const addr = escapeHtml(p.address || "");
        const phone = escapeHtml(p.phone || "Not available");
        const dist = escapeHtml(p.distanceText || "");
        const patientType = escapeHtml(p.patientType || "Unknown");
        const nhsUrl = p.nhsUrl || "";
        const mapUrl = p.mapUrl || "";

        let links = [];
        if (nhsUrl) {
          links.push(`<a href="${nhsUrl}" target="_blank" rel="noopener">NHS page</a>`);
        }
        if (mapUrl) {
          links.push(`<a href="${mapUrl}" target="_blank" rel="noopener">Map</a>`);
        }

        return `
          <div class="card">
            <h3>${name}</h3>
            ${addr ? `<div class="muted">${addr}</div>` : ""}
            <div style="margin-top:4px;font-size:13px;">
              <strong>Phone:</strong> ${phone}<br>
              ${dist ? `<strong>Distance:</strong> ${dist}<br>` : ""}
              ${patientType ? `<strong>Patients:</strong> ${patientType}<br>` : ""}
            </div>
            ${links.length ? `<div style="margin-top:6px;font-size:12px;">${links.join(" · ")}</div>` : ""}
          </div>
        `;
      }

      function renderColumn(title, items) {
        return `
          <div>
            <div class="section-title">
              ${title}
              <span class="badge">${items.length}</span>
            </div>
            ${items.length === 0
              ? `<div class="muted">No practices in this category.</div>`
              : items.map(renderPracticeCard).join("")}
          </div>
        `;
      }

      async function runScan() {
        const postcode = pcEl.value.trim();
        const radius = radiusEl.value.trim();

        if (!postcode) {
          setStatus("Enter postcode", "err");
          return;
        }
        const n = parseInt(radius, 10);
        if (isNaN(n) || n < 1 || n > 30) {
          setStatus("Radius must be between 1 and 30 miles", "err");
          return;
        }

        localStorage.setItem("dr_admin_pc", postcode);
        localStorage.setItem("dr_admin_radius", radius);

        setStatus("Running…");
        outEl.innerHTML = "";

        try {
          const url = `/api/scan?postcode=${encodeURIComponent(postcode)}&radius=${encodeURIComponent(radius)}`;
          const res = await fetch(url, { method: "GET" });

          // If server fell back to HTML, this will blow up below – catch will show message.
          const data = await res.json();

          if (!data || typeof data !== "object") {
            setStatus("Invalid response shape", "err");
            outEl.textContent = JSON.stringify(data, null, 2);
            return;
          }

          const scanned = data.scanned || 0;
          const acceptingCount = data.acceptingCount || 0;
          const notAcceptingCount = data.notAcceptingCount || 0;
          const unknownCount = data.unknownCount || 0;
          const tookMs = data.tookMs || 0;

          setStatus(
            `OK — scanned=${scanned}, accepting=${acceptingCount}, notAccepting=${notAcceptingCount}, unknown=${unknownCount}, took=${tookMs}ms`,
            "ok"
          );

          const accepting = data.accepting || [];
          const notAccepting = data.notAccepting || [];
          const unknown = data.unknown || [];

          // Raw JSON summary
          const pre = document.createElement("pre");
          pre.className = "mono";
          pre.textContent = JSON.stringify(
            {
              postcode: data.postcode,
              radiusMiles: data.radiusMiles,
              scanned,
              acceptingCount,
              notAcceptingCount,
              unknownCount,
              tookMs,
            },
            null,
            2
          );
          outEl.appendChild(pre);

          const grid = document.createElement("div");
          grid.className = "grid";
          grid.innerHTML =
            renderColumn("Accepting", accepting) +
            renderColumn("Not accepting", notAccepting) +
            renderColumn("Unknown / no update", unknown);

          outEl.appendChild(grid);
        } catch (err) {
          console.error(err);
          setStatus(err.message || "Error parsing response", "err");
        }
      }

      runBtn.addEventListener("click", runScan);
    })();
  </script>
</body>
</html>
