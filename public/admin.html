<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî Dentist Radar</title>
<link rel="icon" href="/assets/favicon.svg">
<link rel="stylesheet" href="/assets/normalize.css">
<link rel="stylesheet" href="/assets/theme.css">
<style>
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{background:#0AA77F;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .card{border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin:8px 0;background:var(--card)}
  #msg{margin:6px 0;color:#0a7}
  input{padding:8px;border:1px solid #e2e8f0;border-radius:8px;background:transparent;color:inherit}
  label{font-size:12px;color:#555}
  .muted{color:#64748b;font-size:12px}
</style></head>
<body>
  <div class="wrap">
    <h1>üõ† Admin</h1>
    <div id="msg" class="muted">Enter details and create a test watch. You will be prompted for your admin password.</div>

    <div class="card">
      <div class="row">
        <div><label>Email</label><br/><input id="email" placeholder="you@gmail.com"/></div>
        <div><label>Postcodes (comma separated)</label><br/><input id="postcode" placeholder="RG41, RG1, SL6"/></div>
        <div><label>Radius</label><br/><input id="radius" type="number" value="10" min="1" max="30"/></div>
        <div style="align-self:end"><button class="btn" id="createBtn">Create test watch</button></div>
        <div style="align-self:end"><button class="btn" id="refreshBtn" style="background:#066">Refresh list</button></div>
      </div>
    </div>

    <h3>Watches</h3>
    <div id="list"></div>
  </div>

<script>
function setMsg(t, ok=true){ const el=document.getElementById('msg'); el.style.color = ok ? '#0a7' : '#b00020'; el.textContent=t; }

async function createTest(){
  const email = document.getElementById('email').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const radius = Number(document.getElementById('radius').value || 10);
  if (!email || !postcode){ setMsg('Please enter both email and postcode(s).', false); return; }

  try{
    const res = await fetch('/api/watch', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email, postcode, radius_miles: radius }) });
    const j = await res.json();
    if (j.ok){
      setMsg('‚úÖ Created ' + (j.created?.length||1) + ' area(s). ' + (j.upgrade_needed ? 'Upgrade recommended for more.' : ''));
      load();
    } else {
      setMsg('‚ùå Error: ' + (j.error||'failed'), false);
    }
  }catch(e){ setMsg('‚ùå Network error: ' + e.message, false); }
}

async function load(){
  try{
    const pass = prompt('Admin password (set ADMIN_PASSWORD env):','');
    const res = await fetch('/api/admin/watches', { headers: { Authorization: 'Basic ' + btoa('admin:'+pass) } });
    if (!res.ok){ setMsg('Auth failed or not set. Make sure ADMIN_PASSWORD is configured.', false); return; }
    const j = await res.json();
    const root = document.getElementById('list'); root.innerHTML='';
    if (!j.items || j.items.length===0){ root.innerHTML='<div class="card">No watches yet.</div>'; return; }
    j.items.forEach(w=>{
      const d = document.createElement('div'); d.className='card';
      d.innerHTML = `<strong>#${w.id}</strong> ¬∑ ${w.postcode} ¬∑ ${w.radius_miles} miles ¬∑ every ${w.frequency_minutes} min ¬∑ email: ${w.contact_email || ''}
      <div style="margin-top:6px"><button class="btn" data-id="${w.id}">Run now</button></div>`;
      d.querySelector('button').onclick = ()=> runScan(w.id, d.querySelector('button'));
      root.appendChild(d);
    });
  }catch(e){ setMsg('‚ùå Could not load watches: ' + e.message, false); }
}

async function runScan(id, btn){
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Running‚Ä¶';
  try{
    const res = await fetch('/api/watch/'+id+'/run', { method:'POST' });
    const j = await res.json();
    if (j.ok){ setMsg('‚úÖ Scan complete. Alerts sent: ' + (j.result?.alerts || 0)); }
    else { setMsg('‚ùå Scan failed: ' + (j.error || 'failed'), false); }
  }catch(e){ setMsg('‚ùå Scan error: ' + e.message, false); }
  btn.disabled = false; btn.textContent = old;
}

document.getElementById('createBtn').addEventListener('click', createTest);
document.getElementById('refreshBtn').addEventListener('click', load);
document.addEventListener('DOMContentLoaded', ()=> setTimeout(load, 200));
</script>
</body>
</html>
