<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin ‚Äî Dentist Radar</title>
<link rel="icon" href="/assets/logo.svg"/>
<link rel="stylesheet" href="/assets/theme.css"/>
</head><body>
<header class="navbar">
  <div class="nav-inner">
    <a class="brand" href="/"><img src="/assets/logo.svg" alt="Dentist Radar logo" width="160" height="40"/><span>Dentist Radar</span></a>
    <nav class="nav-links" aria-label="Main">
      <a href="/pricing.html">Pricing</a>
      <a href="/admin.html" aria-current="page">Admin</a>
    </nav>
  </div>
</header>
<div class="wrap">
  <div class="card">
    <h1>üõ† Admin</h1>
    <p class="note" id="msg">Create a test watch, list all watches, and run a manual scan.</p>
  </div>
  <div class="card">
    <div class="grid">
      <div class="full">
        <label>Email</label>
        <input id="email" placeholder="you@gmail.com"/>
      </div>
      <div class="full">
        <label>Postcodes (comma separated)</label>
        <input id="postcode" placeholder="RG41, RG1, SL6"/>
      </div>
      <div>
        <label>Radius</label>
        <input id="radius" type="number" value="10" min="1" max="30"/>
      </div>
      <div class="full cta">
        <button class="btn" id="createBtn">Create test watch</button>
        <button class="btn" id="refreshBtn" style="background:linear-gradient(135deg,#06B6D4,#10B981)">Refresh list</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Watches</h2>
    <div id="list"></div>
  </div>
  <div class="card"><a href="/">‚Üê Back to Home</a></div>
</div>
<script>
function setMsg(t, ok=true){ const el=document.getElementById('msg'); el.style.color = ok ? '#22C55E' : '#F87171'; el.textContent=t; }
async function createTest(){
  const email = document.getElementById('email').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const radius = Number(document.getElementById('radius').value || 10);
  if (!email || !postcode){ setMsg('Please enter both email and postcode(s).', false); return; }
  try{
    const res = await fetch('/api/watch', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email, postcode, radius_miles: radius }) });
    const txt = await res.text(); let j; try{ j = JSON.parse(txt);}catch(e){ j=null; }
    if (!res.ok){ setMsg('HTTP '+res.status+': '+(j?.error || txt || 'failed'), false); return; }
    if (j && j.ok){ setMsg('‚úÖ Created ' + (j.created?.length||1) + ' area(s).', true); load(); }
    else { setMsg('‚ùå Error: ' + (j?.error || 'failed'), false); }
  }catch(e){ setMsg('‚ùå Network error: ' + e.message, false); }
}
async function load(){
  try{
    const pass = prompt('Admin password (set ADMIN_PASSWORD env):','');
    if (pass===null){ setMsg('Load canceled.', false); return; }
    const res = await fetch('/api/admin/watches', { headers: { Authorization: 'Basic ' + btoa('admin:'+pass) } });
    if (!res.ok){ setMsg('Auth failed or server error ('+res.status+'). Check ADMIN_PASSWORD.', false); return; }
    const j = await res.json();
    const root = document.getElementById('list'); root.innerHTML='';
    if (!j.items || j.items.length===0){ root.innerHTML='<div class="note">No watches yet.</div>'; return; }
    j.items.forEach(w=>{
      const d = document.createElement('div'); d.className='card';
      d.innerHTML = `<strong>#${w.id}</strong> ¬∑ ${w.postcode} ¬∑ ${w.radius_miles} miles ¬∑ email: ${w.email}
      <div style="margin-top:6px"><button class="btn" data-id="${w.id}">Run now</button></div>`;
      d.querySelector('button').onclick = ()=> runScan(w.id, d.querySelector('button'));
      root.appendChild(d);
    });
    setMsg('‚úÖ Loaded '+j.items.length+' watch(es).', true);
  }catch(e){ setMsg('‚ùå Could not load watches: ' + e.message, false); }
}
async function runScan(id, btn){
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Running‚Ä¶';
  try{
    const res = await fetch('/api/watch/'+id+'/run', { method:'POST' });
    const j = await res.json();
    if (j.ok){ setMsg('‚úÖ Scan complete. Alerts sent: ' + (j.result?.alerts || 0), true); }
    else { setMsg('‚ùå Scan failed: ' + (j.error || 'failed'), false); }
  }catch(e){ setMsg('‚ùå Scan error: ' + e.message, false); }
  btn.disabled = false; btn.textContent = old;
}
document.getElementById('createBtn').addEventListener('click', createTest);
document.getElementById('refreshBtn').addEventListener('click', load);
</script>
</body></html>
