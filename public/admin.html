<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Dentist Radar</title>
  <link rel="icon" href="/favicon.svg"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="/" class="logo"><img src="/logo.svg" alt="Dentist Radar"/></a>
      <button class="menu-toggle" id="menu-toggle">☰</button>
      <ul class="nav-links" id="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/pricing.html">Pricing</a></li>
        <li><a href="/about.html">About</a></li>
        <li><a href="/terms.html">Terms</a></li>
        <li><a href="/privacy.html">Privacy</a></li>
        <li><a class="active" href="/admin.html">Admin</a></li>
      </ul>
    </nav>
  </header>

  <main class="hero" style="max-width:980px;margin:auto">
    <h1>Admin</h1>
    <div class="alert-form">
      <p id="banner" class="message"></p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="load">Load Alerts</button>
        <button class="btn-secondary" id="scan">Run Scan</button>
        <span id="kpis" class="message"></span>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table class="table" id="tbl">
          <thead>
            <tr><th>Email</th><th>Postcode</th><th>Radius</th><th>Plan</th><th>Created</th><th>Last scanned</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer><p>© 2025 Dentist Radar</p></footer>

  <script>
    const menuToggle=document.getElementById('menu-toggle');
    const navLinks=document.getElementById('nav-links');
    menuToggle?.addEventListener('click',()=>navLinks.classList.toggle('open'));

    const $=s=>document.querySelector(s);
    function show(m,c='#0a0'){ const b=$('#banner'); b.textContent=m; b.style.color=c; }

    $('#load')?.addEventListener('click', async ()=>{
      const pw = localStorage.getItem('admin_pw') || prompt('Admin password:') || '';
      if (pw) localStorage.setItem('admin_pw', pw);
      const res = await fetch('/api/watches', { headers:{'x-admin': pw} });
      const j = await res.json().catch(()=>null);
      if(!res.ok || !j?.ok){ return show('Auth failed or load error','#d00'); }
      const tb = $('#tbl tbody'); tb.innerHTML='';
      (j.items||[]).forEach(w=>{
        const tr=document.createElement('tr');
        const c=w.created?new Date(w.created).toLocaleString('en-GB'):'';
        const ls=w.lastScannedAt?new Date(w.lastScannedAt).toLocaleString('en-GB'):'—';
        tr.innerHTML=`<td>${w.email||''}</td><td>${w.postcode||''}</td><td>${w.radius||''}</td><td>${w.plan||'free'}</td><td>${c}</td><td>${ls}</td>`;
        tb.appendChild(tr);
      });
      show('Loaded alerts');
      $('#kpis').textContent = `Alerts: ${j.items?.length||0}${j.paidUsers?(' · Paid users: '+j.paidUsers):''}`;
    });

    $('#scan')?.addEventListener('click', async ()=>{
      const tok = localStorage.getItem('scan_token') || prompt('SCAN_TOKEN:') || '';
      if (tok) localStorage.setItem('scan_token', tok);
      const res = await fetch('/api/scan?token='+encodeURIComponent(tok), { method:'POST' });
      const j = await res.json().catch(()=>null);
      if(res.ok && j?.ok) show('Scan started: '+(j.time||'OK')); else show('Scan failed','#d00');
    });
  </script>
</body>
</html>
