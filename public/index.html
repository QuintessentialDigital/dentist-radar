<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dentist Radar</title>
  <meta name="description" content="Be first to know when an NHS dentist near you starts accepting new patients. Create postcode alerts in seconds — free plan available."/>
  <!-- Brand assets -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="preload" as="image" href="/logo.svg" imagesizes="(max-width: 480px) 160px, 240px">
  <!-- Social cards -->
  <meta property="og:title" content="Dentist Radar">
  <meta property="og:description" content="Get instant email alerts when nearby NHS dentists start accepting NHS patients.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/favicon.svg">
  <meta name="twitter:card" content="summary">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Top nav -->
  <header class="navbar">
    <div class="nav-inner">
      <a class="brand" href="/" aria-label="Dentist Radar">
        <!-- Uses your previous logo file -->
        <img src="/logo.svg" alt="Dentist Radar" width="240" height="44" />
      </a>
      <nav class="nav-links">
        <a href="/about.html">About</a>
        <a href="/terms.html">Terms</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="wrap">
    <!-- Hero + form -->
    <section class="card hero">
      <div class="hero-text">
        <h1>Be first to know about NHS dentist openings</h1>
        <p class="lead">
          We monitor public NHS sources and email you the moment a nearby practice starts accepting new NHS patients.
        </p>

        <form id="alertForm" class="form-grid" novalidate>
          <!-- Email -->
          <div class="f-group">
            <input id="email" name="email" type="email" required
                   inputmode="email" autocomplete="email" placeholder=" "
                   class="f-input"/>
            <label for="email" class="f-label">Email</label>
            <div class="help">We’ll send alerts here.</div>
          </div>

          <!-- Postcodes -->
          <div class="f-group">
            <input id="postcode" name="postcode" type="text" required
                   inputmode="text" placeholder=" "
                   class="f-input f-uppercase"/>
            <label for="postcode" class="f-label">Postcode(s)</label>
            <div class="help">
              Free plan allows up to <strong>2 postcodes</strong> per email. Separate with commas (e.g., <code>RG41, RG1</code>).
            </div>
          </div>

          <!-- Radius -->
          <div class="f-group">
            <input id="radius" name="radius" type="number" required
                   inputmode="numeric" min="1" max="30" step="1" value="10"
                   placeholder=" " class="f-input"/>
            <label for="radius" class="f-label">Radius (miles)</label>
            <div class="help">1–30 miles.</div>
          </div>

          <button id="createBtn" class="btn" type="submit">
            <span class="btn-label">Create alert</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>

          <div id="err" class="banner error" hidden></div>
          <div id="info" class="banner info" hidden></div>
        </form>
      </div>
    </section>

    <!-- How it works -->
    <section class="card">
      <h2>How it works</h2>
      <div class="how">
        <div class="step"><strong>1.</strong> Tell us your areas (postcodes)</div>
        <div class="step"><strong>2.</strong> We watch automatically (faster on Pro)</div>
        <div class="step"><strong>3.</strong> You get an email when there’s availability</div>
      </div>
    </section>

    <!-- Trust strip -->
    <section class="card trust">
      <h2>Why people use Dentist Radar</h2>
      <ul class="trust-list">
        <li><strong>Made in the UK.</strong> Built for NHS patients.</li>
        <li><strong>Privacy first.</strong> We only store what’s needed for alerts.</li>
        <li><strong>Transparent.</strong> We monitor public NHS pages; please confirm directly before travel.</li>
      </ul>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div>© 2025 Dentist Radar</div>
      <nav class="footer-links">
        <a href="/about.html">About</a>
        <a href="/terms.html">Terms</a>
        <a href="/privacy.html">Privacy</a>
      </nav>
    </div>
  </footer>

  <!-- Toast (success) -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- App JS -->
  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const err   = $('err');
    const info  = $('info');
    const btn   = $('createBtn');
    const form  = $('alertForm');
    const toastEl = $('toast');
    const btnLabel = btn.querySelector('.btn-label');
    const spinner  = btn.querySelector('.spinner');

    // ✅ Correct, cross-browser regex
    const emailRe = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
    const fullUK  = /^[A-Z]{1,2}\\d[A-Z\\d]?\\s*\\d[A-Z]{2}$/;  // RG41 3XX, W1A 1HQ
    const outward = /^[A-Z]{1,2}\\d[A-Z\\d]?$/;                // RG41, W1A, EC1

    function validPostcodeToken(tok){
      const t = tok.replace(/\\s+/g,'').toUpperCase();
      return fullUK.test(t) || outward.test(t);
    }

    function validate(email, postcode, radius){
      if (!email || !emailRe.test(email)) return 'Please enter a valid email.';
      const r = Number(radius);
      if (!Number.isInteger(r) || r < 1 || r > 30) return 'Radius must be 1–30 miles.';
      const tokens = postcode.split(',').map(s=>s.trim()).filter(Boolean);
      if (!tokens.length) return 'Enter at least one postcode.';
      for (const t of tokens){
        if (!validPostcodeToken(t)) return 'Invalid postcode: "'+t+'". Use full postcode (e.g., RG41 3XX) or outward (e.g., RG41).';
      }
      return null;
    }

    function show(el,msg){ el.hidden=false; el.textContent=msg; }
    function hide(el){ el.hidden=true; el.textContent=''; }

    // Auto-uppercase & tidy spaces in postcode
    $('postcode').addEventListener('input', e => {
      const v = e.target.value
        .toUpperCase()
        .replace(/\\s+/g,' ')
        .replace(/,\\s*/g,', ');
      e.target.value = v;
    });

    // Toast helpers
    function showToast(message, type='success'){
      toastEl.textContent = message;
      toastEl.className = 'toast ' + (type==='success' ? 'toast-success' : 'toast-error');
      requestAnimationFrame(()=> toastEl.classList.add('show'));
      setTimeout(()=> toastEl.classList.remove('show'), 3200);
    }

    function setLoading(on){
      if (on){ btn.disabled = true; btnLabel.textContent='Creating…'; spinner.style.display='inline-block'; }
      else   { btn.disabled = false; btnLabel.textContent='Create alert'; spinner.style.display='none'; }
    }

    form.addEventListener('submit', async e=>{
      e.preventDefault(); hide(err); hide(info);

      const email = $('email').value.trim();
      const radius = $('radius').value.trim();
      const postcode = $('postcode').value.trim();

      const problem = validate(email, postcode, radius);
      if (problem){ show(err, problem); return; }

      try{
        setLoading(true);
        const res = await fetch('/api/watch', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, postcode, radius:Number(radius) })
        });

        const j = await res.json().catch(()=>null);
        if (res.ok && j && j.ok){
          if (j.duplicates > 0) show(info, `Note: ${j.duplicates} duplicate ${j.duplicates===1?'postcode was':'postcodes were'} skipped.`);
          showToast('✅ Alert created! We’ll email you when a match appears.','success');
          form.reset();
        } else {
          if (j && j.code === 'free_limit') {
            show(err, j.error + ' Consider upgrading to Pro for more areas.');
          } else {
            show(err, (j && j.error) ? ('❌ ' + j.error) : '❌ Could not create alert.');
          }
        }
      } catch(ex){
        show(err, 'Network error: ' + (ex && ex.message ? ex.message : 'unknown'));
      } finally {
        setLoading(false);
      }
    });
  })();
  </script>
</body>
</html>
