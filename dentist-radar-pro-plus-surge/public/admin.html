<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dentist Radar ‚Äî Admin</title>
  <style>
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:20px; }
    h1{ margin:0 0 10px; }
    section{ margin: 20px 0; padding:12px; border:1px solid #eee; border-radius:12px; }
    input, select, button{ padding:8px 10px; margin:4px 0; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ text-align:left; border-bottom:1px solid #eee; padding:8px; }
    .card{ border:1px solid #eee; border-radius:10px; padding:10px; margin-bottom:8px; }
  </style>
</head>
<body>
  <h1>üõ†Ô∏è Dentist Radar ‚Äî Admin</h1>
  <p>Use your admin password when prompted by the browser. If you see 401/403, set <code>ADMIN_PASSWORD</code> in your environment.</p>

  <section>
    <h3>Users</h3>
    <div>
      <button onclick="loadUsers()">Refresh</button>
      <div id="users"></div>
    </div>
    <div>
      <h4>Set user plan</h4>
      <input id="uid" placeholder="User ID"/>
      <select id="plan">
        <option value="free">free</option>
        <option value="pro">pro</option>
        <option value="agency">agency</option>
      </select>
      <button onclick="setPlan()">Set Plan</button>
    </div>
  </section>

  <section>
    <h3>Watches</h3>
    <button onclick="loadWatches()">Refresh</button>
    <div id="watches"></div>
  </section>

  <section>
    <h3>API Keys (Agency)</h3>
    <div>
      <input id="ak_uid" placeholder="User ID"/>
      <input id="ak_label" placeholder="Label (optional)"/>
      <button onclick="createKey()">Create API Key</button>
    </div>
    <div>
      <input id="ak_uid_list" placeholder="User ID for list"/>
      <button onclick="listKeys()">List Keys</button>
      <div id="keys"></div>
    </div>
  </section>

<script>
  function authHeaders(){
    // Browser will show a login prompt automatically when server replies 401 with WWW-Authenticate header.
    // We don't handle Basic header here; rely on browser's built-in prompt.
    return { 'content-type':'application/json' };
  }
  async function loadUsers(){
    const r = await fetch('/api/admin/users');
    if (r.status===401){ alert('Enter the admin password in the browser prompt and retry.'); return; }
    const j = await r.json();
    const root = document.getElementById('users'); root.innerHTML='';
    (j.items||[]).forEach(u => {
      const div = document.createElement('div'); div.className='card';
      div.textContent = `#${u.id} ${u.email} ‚Äî plan: ${u.plan}`;
      root.appendChild(div);
    });
  }
  async function setPlan(){
    const id = document.getElementById('uid').value;
    const p = document.getElementById('plan').value;
    const r = await fetch('/api/admin/users/'+id+'/plan', { method:'POST', headers:authHeaders(), body: JSON.stringify({ plan:p }) });
    const j = await r.json();
    if (j.ok){ alert('Plan updated'); loadUsers(); } else { alert('Error'); }
  }
  async function loadWatches(){
    const r = await fetch('/api/admin/watches');
    const j = await r.json();
    const root = document.getElementById('watches'); root.innerHTML='';
    (j.items||[]).forEach(w => {
      const div = document.createElement('div'); div.className='card';
      div.textContent = `#${w.id} user:${w.user_id||'-'} ${w.user_email||''} ‚Äî ${w.region} ${w.postcode} (${w.radius_miles} mi) every ${w.frequency_minutes} min`;
      root.appendChild(div);
    });
  }
  async function createKey(){
    const user_id = Number(document.getElementById('ak_uid').value);
    const label = document.getElementById('ak_label').value;
    const r = await fetch('/api/admin/api-keys', { method:'POST', headers:authHeaders(), body: JSON.stringify({ user_id, label }) });
    const j = await r.json();
    if (j.ok){ alert('API Key: ' + j.key); } else { alert('Error creating key'); }
  }
  async function listKeys(){
    const user_id = Number(document.getElementById('ak_uid_list').value);
    const r = await fetch('/api/admin/api-keys?user_id='+user_id);
    const j = await r.json();
    const root = document.getElementById('keys'); root.innerHTML='';
    (j.items||[]).forEach(k => {
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `#${k.id} ${k.label||''} ‚Äî <code>${k.key}</code> <button onclick="delKey(${k.id})">Delete</button>`;
      root.appendChild(div);
    });
  }
  async function delKey(id){
    const r = await fetch('/api/admin/api-keys/'+id, { method:'DELETE' });
    const j = await r.json();
    if (j.ok){ alert('Deleted'); listKeys(); }
  }
</script>
</body>
</html>
